<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload de Arquivos - Tratamento de Dados</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #4a5568;
            --primary-hover: #2d3748;
            --secondary-color: #64748b;
            --background: #f8fafc;
            --card-background: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --border-color: #e2e8f0;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --success-color: #10b981;
            --error-color: #ef4444;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .header {
            background: var(--card-background);
            border-bottom: 1px solid var(--border-color);
            padding: 1.25rem 2rem;
            box-shadow: var(--shadow);
        }

        .header-content {
            max-width: 800px;
            margin: 0 auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: var(--primary-color);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
        }

        .container {
            width: 100%;
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .upload-card {
            background: var(--card-background);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .card-header h2 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .card-header p {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .file-counter {
            display: inline-block;
            margin-left: 0.5rem;
            padding: 0.125rem 0.5rem;
            background: var(--primary-color);
            color: white;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .card-content {
            padding: 1.5rem;
        }

        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 3rem 2rem;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            background: var(--background);
        }

        .upload-area:hover {
            border-color: var(--primary-color);
            background: rgba(74, 85, 104, 0.02);
        }

        .upload-area.drag-over {
            border-color: var(--primary-color);
            background: rgba(74, 85, 104, 0.05);
            transform: scale(1.01);
        }

        .upload-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 1rem;
            background: rgba(74, 85, 104, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .upload-icon svg {
            width: 32px;
            height: 32px;
            color: var(--primary-color);
        }

        .upload-text h3 {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .upload-text p {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .file-types {
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        #fileInput {
            display: none;
        }

        /* ⭐ NOVO: Layout em Grid para arquivos */
        .files-list {
            display: none;
            margin-top: 1rem;
        }

        .files-list.active {
            display: block;
        }

        .files-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem;
            background: var(--background);
            border-radius: 6px;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .file-item:hover {
            border-color: var(--primary-color);
        }

        .file-icon {
            width: 36px;
            height: 36px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .file-icon svg {
            width: 20px;
            height: 20px;
            color: var(--success-color);
        }

        .file-details {
            flex: 1;
            min-width: 0;
        }

        .file-name {
            font-weight: 500;
            font-size: 0.875rem;
            color: var(--text-primary);
            margin-bottom: 0.125rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-size {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .remove-file {
            width: 28px;
            height: 28px;
            padding: 0;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .remove-file:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error-color);
        }

        .remove-file svg {
            width: 16px;
            height: 16px;
        }

        .info-alert {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.875rem;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 6px;
            margin-bottom: 1rem;
            color: #1e40af;
            font-size: 0.875rem;
        }

        .info-alert svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .add-more-btn {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
            padding: 0.875rem;
            background: transparent;
            border: 2px dashed var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 1rem;
        }

        .add-more-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            background: rgba(74, 85, 104, 0.02);
        }

        .add-more-btn svg {
            width: 20px;
            height: 20px;
        }

        .actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.875rem 1.25rem;
            border-radius: 6px;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            display: none;
        }

        .btn-secondary:hover {
            background: var(--background);
            border-color: var(--text-secondary);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 640px) {
            .files-grid {
                grid-template-columns: 1fr;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">TD</div>
                <span>Tratamento de Dados</span>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="upload-card">
            <div class="card-header">
                <h2>Upload de Arquivos <span class="file-counter" id="fileCounter">0/8</span></h2>
                <p>Faça upload de até 8 arquivos Excel para processamento simultâneo</p>
            </div>

            <div class="card-content">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                    </div>
                    <div class="upload-text">
                        <h3>Arraste arquivos aqui ou clique para selecionar</h3>
                        <p>Suporta múltiplos arquivos Excel (até 8 arquivos)</p>
                        <p class="file-types">Formatos aceitos: .xlsx, .xls • Máximo 20MB por arquivo</p>
                    </div>
                    <input type="file" id="fileInput" multiple accept=".xlsx,.xls">
                </div>

                <div class="files-list" id="filesList">
                    <div class="info-alert" id="infoAlert">
                        <svg fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                        </svg>
                        <span>Processamento paralelo: Todos os arquivos serão processados simultaneamente para máxima velocidade!</span>
                    </div>
                    
                    <!-- Grid de arquivos será inserido aqui -->
                    <div class="files-grid" id="filesGrid"></div>

                    <button class="add-more-btn" id="addMoreBtn">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Adicionar mais arquivos
                    </button>
                </div>

                <div class="actions">
                    <button class="btn btn-secondary" id="cancelBtn">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        Limpar Tudo
                    </button>
                    <button class="btn btn-primary" id="uploadBtn" disabled>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        <span id="uploadBtnText">Processar Arquivos</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const MAX_FILES = 8;
        const MAX_FILE_SIZE = 20 * 1024 * 1024; // 20MB

        let selectedFiles = [];
        let processedFiles = []; // ⭐ Armazena arquivos processados

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const filesGrid = document.getElementById('filesGrid');
        const filesList = document.getElementById('filesList');
        const fileCounter = document.getElementById('fileCounter');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadBtnText = document.getElementById('uploadBtnText');
        const cancelBtn = document.getElementById('cancelBtn');
        const addMoreBtn = document.getElementById('addMoreBtn');
        const infoAlert = document.getElementById('infoAlert');

        uploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFilesSelect(e.target.files));
        addMoreBtn.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('drag-over'));

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            handleFilesSelect(e.dataTransfer.files);
        });

        function handleFilesSelect(files) {
            if (!files || files.length === 0) return;

            const validTypes = [
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                'application/vnd.ms-excel'
            ];

            let addedCount = 0;

            for (const file of files) {
                if (selectedFiles.length >= MAX_FILES) {
                    alert(`Limite de ${MAX_FILES} arquivos atingido!`);
                    break;
                }

                if (!validTypes.includes(file.type)) {
                    alert(`Arquivo "${file.name}" não é um Excel válido (.xlsx ou .xls)`);
                    continue;
                }

                if (file.size > MAX_FILE_SIZE) {
                    alert(`Arquivo "${file.name}" excede o tamanho máximo de 20MB`);
                    continue;
                }

                // Verifica duplicatas
                if (selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
                    alert(`Arquivo "${file.name}" já foi adicionado`);
                    continue;
                }

                selectedFiles.push(file);
                addedCount++;
            }

            if (addedCount > 0) {
                updateUI();
            }

            fileInput.value = '';
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateUI();
        }

        function updateUI() {
            fileCounter.textContent = `${selectedFiles.length}/${MAX_FILES}`;
            
            if (selectedFiles.length > 0) {
                uploadArea.style.display = 'none';
                filesList.classList.add('active');
                uploadBtn.disabled = false;
                cancelBtn.style.display = 'block';
                
                if (selectedFiles.length < MAX_FILES) {
                    addMoreBtn.style.display = 'flex';
                } else {
                    addMoreBtn.style.display = 'none';
                }

                // ⭐ Renderiza grid de arquivos
                filesGrid.innerHTML = selectedFiles.map((file, index) => `
                    <div class="file-item">
                        <div class="file-icon">
                            <svg fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="file-details">
                            <div class="file-name" title="${file.name}">${file.name}</div>
                            <div class="file-size">${formatFileSize(file.size)}</div>
                        </div>
                        <button class="remove-file" onclick="removeFile(${index})" title="Remover arquivo">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                `).join('');

                // Atualiza mensagem informativa e botão
                if (selectedFiles.length === 1) {
                    infoAlert.innerHTML = `
                        <svg fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                        </svg>
                        <span>1 arquivo pronto. Adicione até ${MAX_FILES - 1} arquivos adicionais para processamento paralelo!</span>
                    `;
                    uploadBtnText.textContent = 'Processar Arquivo';
                } else {
                    infoAlert.innerHTML = `
                        <svg fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                        </svg>
                        <span>${selectedFiles.length} arquivos prontos para processamento simultâneo! ⚡</span>
                    `;
                    uploadBtnText.textContent = 'Processar Arquivos';
                }
            } else {
                resetForm();
            }
        }

        cancelBtn.addEventListener('click', () => {
            if (confirm('Deseja limpar todos os arquivos selecionados?')) {
                selectedFiles = [];
                processedFiles = [];
                resetForm();
            }
        });

        uploadBtn.addEventListener('click', async () => {
            if (selectedFiles.length === 0) return;

            uploadBtn.disabled = true;
            uploadBtn.innerHTML = `
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="animation: spin 1s linear infinite;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                <span>Processando ${selectedFiles.length} arquivo(s)...</span>
            `;

            const formData = new FormData();
            selectedFiles.forEach((file, index) => {
                formData.append(`file${index + 1}`, file);
            });

            try {
                const webhookURL = 'https://projeto-teste-n8n.ly7t0m.easypanel.host/webhook-test/processar-8-arquivos';
                
                const response = await fetch(webhookURL, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const contentType = response.headers.get('content-type');
                    
                    // ⭐ LÓGICA DE DOWNLOAD INTELIGENTE
                    if (selectedFiles.length === 1) {
                        // 1 arquivo → Download direto do Excel
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = selectedFiles[0].name.replace('.xlsx', '_processado.xlsx').replace('.xls', '_processado.xls');
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        a.remove();
                        
                        alert(`✅ Arquivo processado com sucesso! O download foi iniciado.`);
                    } else {
                        // 2+ arquivos → Download do ZIP
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `processados_${new Date().toISOString().split('T')[0]}.zip`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        a.remove();
                        
                        alert(`✅ ${selectedFiles.length} arquivos processados com sucesso! O download do ZIP foi iniciado.`);
                    }
                    
                    selectedFiles = [];
                    resetForm();
                } else {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Erro no processamento');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert(`❌ Erro ao processar arquivos: ${error.message}\n\nTente novamente.`);
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = `
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    <span id="uploadBtnText">Processar Arquivos</span>
                `;
            }
        });

        function resetForm() {
            filesList.classList.remove('active');
            uploadArea.style.display = 'block';
            uploadBtn.disabled = true;
            addMoreBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
            fileCounter.textContent = '0/8';
            uploadBtn.innerHTML = `
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
                <span id="uploadBtnText">Processar Arquivos</span>
            `;
            infoAlert.innerHTML = `
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                </svg>
                <span>Adicione até 8 arquivos Excel para processamento simultâneo!</span>
            `;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
    </script>
</body>
</html>
