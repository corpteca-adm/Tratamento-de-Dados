<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tratamento de Dados — Upload</title>

  <style>
    /* ====== Design tokens (corporate, clean) ====== */
    :root{
      --bg:#f4f6f8;
      --surface:#ffffff;
      --muted:#6b7280;
      --text:#0f1724;
      --primary:#0b5fff;
      --primary-600:#084fcc;
      --border:#e6eef8;
      --success:#10b981;
      --danger:#ef4444;
      --shadow: 0 6px 18px rgba(12, 20, 36, 0.06);
      --radius:10px;
      --glass: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(250,250,250,0.9));
      font-size:16px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.45;
    }

    .wrap{ max-width:980px; margin:36px auto; padding:24px; }

    header.appbar{
      display:flex; align-items:center; gap:16px;
      padding:18px 24px; background:var(--surface);
      border-radius:12px; box-shadow:var(--shadow); border:1px solid var(--border);
    }
    .brand{ display:flex; gap:12px; align-items:center; }
    .brand-logo{ width:44px; height:44px; background:linear-gradient(180deg,var(--primary),var(--primary-600));
      border-radius:8px; display:flex; align-items:center; justify-content:center; color:white; font-weight:700;
      box-shadow:0 4px 12px rgba(11,95,255,0.15);
    }
    .brand-title{ font-weight:600; font-size:1.0625rem; }
    .brand-sub{ font-size:0.875rem; color:var(--muted); }

    main.card{ margin-top:20px; background:var(--surface); border-radius:var(--radius); border:1px solid var(--border);
      box-shadow:var(--shadow); overflow:hidden; }

    .card-header{ padding:20px 24px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
    .card-header h1{ font-size:1.0625rem; margin:0; font-weight:600; }
    .card-header p{ margin:0; color:var(--muted); font-size:0.875rem; }

    .card-body{ padding:26px; }

    .upload-area{
      border-radius:12px; border:1px dashed var(--border); padding:30px; display:flex; gap:20px; align-items:center;
      background:var(--glass); transition:all .16s ease; cursor:pointer; position:relative;
    }
    .upload-area.hover{ box-shadow:0 6px 18px rgba(11,95,255,0.06); border-color:var(--primary); transform:translateY(-2px); }
    .upload-icon{ width:64px; height:64px; display:flex; align-items:center; justify-content:center; border-radius:10px;
      background:linear-gradient(180deg, rgba(11,95,255,0.09), rgba(11,95,255,0.04)); flex-shrink:0; }
    .upload-icon svg{ width:32px; height:32px; color:var(--primary); display:block; }

    .upload-info{ flex:1; }
    .upload-info h2{ margin:0; font-size:1.0625rem; font-weight:600; }
    .upload-info p{ margin:6px 0 0; color:var(--muted); font-size:0.95rem }
    .file-types{ margin-top:8px; color:var(--muted); font-size:0.85rem }

    .controls{ margin-top:18px; display:flex; gap:12px; align-items:center; justify-content:flex-end; }

    /* Buttons - subtle interactive and predictable layout */
    .btn{
      padding:10px 14px; border-radius:8px; border:1px solid transparent; background:transparent;
      cursor:pointer; font-weight:600; display:inline-flex; gap:8px; align-items:center;
      transition:transform .12s ease, box-shadow .12s ease, background-color .12s ease, opacity .12s ease;
      vertical-align:middle; text-decoration:none;
    }
    .btn:focus{ outline:3px solid rgba(11,95,255,0.12); outline-offset:2px }
    .btn:hover{ transform:translateY(-3px); box-shadow:0 10px 18px rgba(12,20,36,0.06) }
    .btn:active{ transform:translateY(-1px) scale(.995); opacity:.98 }

    .btn.primary{ background:var(--primary); color:white; border-color:transparent; box-shadow:0 6px 12px rgba(11,95,255,0.08); }
    .btn.ghost{ background:#fff; color:var(--text); border:1px solid var(--border); }

    .btn svg{ display:inline-block; width:16px; height:16px; flex-shrink:0; }
    .btn .btn-label{ display:inline-block; line-height:1; }

    .btn:disabled{ opacity:0.6; cursor:not-allowed; transform:none; box-shadow:none }

    .files-list{ margin-top:18px }
    .files-grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-top:12px; }
    .file-card{ background:transparent; border-radius:10px; padding:12px; display:flex; gap:12px; align-items:center; border:1px solid var(--border);
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease; }
    .file-card:hover{ transform:translateY(-4px); box-shadow:0 8px 20px rgba(12,20,36,0.05); border-color:rgba(11,95,255,0.06) }
    .file-thumb{ width:44px; height:44px; border-radius:8px; background:linear-gradient(180deg,rgba(16,185,129,0.06),rgba(16,185,129,0.02));
      display:flex; align-items:center; justify-content:center; color:var(--success); flex-shrink:0; }
    .file-meta{ flex:1; min-width:0 }
    .file-name{ font-weight:600; font-size:0.95rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .file-size{ color:var(--muted); font-size:0.85rem; margin-top:4px }

    .file-actions{ display:flex; gap:8px; align-items:center }
    .icon-btn{ width:36px; height:36px; display:inline-flex; align-items:center; justify-content:center; border-radius:8px; border:1px solid transparent;
      background:transparent; cursor:pointer; transition:transform .12s ease, background-color .12s ease, border-color .12s ease; }
    .icon-btn:hover{ background:rgba(11,95,255,0.04); transform:translateY(-2px) }
    .icon-btn.danger{ border-color:rgba(239,68,68,0.08); color:var(--danger) }

    .processing{ padding:36px; text-align:center; }
    .spinner{ margin:0 auto 18px; width:72px;height:72px;border-radius:50%; border:6px solid var(--border); border-top-color:var(--primary); animation:spin 1.05s linear infinite; }
    @keyframes spin{ to{ transform:rotate(360deg)} }
    .processing h3{ margin:8px 0 0; font-size:1.125rem; font-weight:700 }
    .processing p{ margin:8px 0 0; color:var(--muted) }

    .results{ padding:22px; }
    .results-grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-top:12px; }
    .result-item{ padding:12px; border-radius:10px; border:1px solid var(--border); display:flex; gap:12px; align-items:center; justify-content:space-between; }
    .result-meta{ display:flex; gap:12px; align-items:center; min-width:0 }
    .result-thumb{ width:44px;height:44px;border-radius:8px;background:linear-gradient(180deg,rgba(59,130,246,0.06),rgba(59,130,246,0.02)); display:flex;align-items:center;justify-content:center;color:var(--primary); }
    .result-name{ font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .result-size{ color:var(--muted); font-size:0.85rem }

    @media (max-width:720px){ .files-grid,.results-grid{ grid-template-columns:1fr } .controls{ flex-direction:column; align-items:stretch } }

    .visually-hidden{ position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px, 1px, 1px, 1px); white-space:nowrap; border:0; padding:0; margin:-1px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="appbar" role="banner">
      <div class="brand">
        <div class="brand-logo" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M14 3H6a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h12a2 2 0 0 0 2-2V9l-6-6z" fill="white"/>
            <path d="M14 3v6h6" fill="rgba(255,255,255,0.14)"/>
          </svg>
        </div>
        <div>
          <div class="brand-title">Tratamento de Dados</div>
          <div class="brand-sub">Processamento corporativo de planilhas</div>
        </div>
      </div>
    </header>

    <main class="card" role="main" aria-live="polite">
      <!-- Upload Screen -->
      <section id="uploadScreen">
        <div class="card-header">
          <div>
            <h1>Carregar arquivos</h1>
            <p id="uploadSubtitle">Selecione até 8 arquivos .xlsx ou .xls para processamento</p>
          </div>
          <div><div id="counterBadge" style="text-align:right; color:var(--muted); font-weight:600">0 / 8</div></div>
        </div>

        <div class="card-body">
          <div id="uploadArea" class="upload-area" tabindex="0" role="button" aria-label="Clique ou arraste arquivos para enviar">
            <div class="upload-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="color:var(--primary)">
                <path d="M16 16l-4-4-4 4" />
                <path d="M12 12v8" />
                <path d="M20.39 16.61A5 5 0 0017 10h-1.26A8 8 0 104 16.29" />
              </svg>
            </div>

            <div class="upload-info">
              <h2 id="uploadTitle">Arraste e solte arquivos</h2>
              <p>Arraste os arquivos para cá ou clique para selecionar.</p>
              <div class="file-types">Formatos aceitos: .xlsx, .xls — Máximo 8 arquivos</div>
            </div>

            <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
              <label id="btnChoose" class="btn ghost" for="fileInput" title="Selecionar arquivos" role="button" aria-label="Selecionar arquivos">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" style="color:var(--muted)">
                  <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h7a2 2 0 0 1 2 2z"/>
                  <path d="M12 11v6M9 14h6"/>
                </svg>
                <span class="btn-label">Selecionar</span>
              </label>
              <div id="uploadHint" style="font-size:0.85rem;color:var(--muted)">Nenhum envio ainda</div>
            </div>
          </div>

          <input id="fileInput" class="visually-hidden" type="file" accept=".xlsx,.xls" multiple aria-hidden="false" />

          <div id="filesList" class="files-list" aria-live="polite" style="display:none">
            <div style="display:flex;align-items:center;justify-content:space-between">
              <div style="color:var(--muted); font-weight:600">Arquivos prontos</div>
              <div style="display:flex; gap:8px; align-items:center">
                <button id="btnClear" class="btn ghost" type="button" title="Limpar seleção" aria-label="Limpar todos os arquivos">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="color:var(--muted)">
                    <path d="M3 6h18" />
                    <path d="M8 6v14a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V6" />
                    <path d="M10 11v6M14 11v6" />
                  </svg>
                  <span class="btn-label">Limpar</span>
                </button>

                <button id="btnAddMore" class="btn" type="button" title="Adicionar mais" style="display:none">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="color:var(--muted)">
                    <path d="M12 5v14M5 12h14" />
                  </svg>
                  <span class="btn-label">Adicionar</span>
                </button>
              </div>
            </div>

            <div id="filesGrid" class="files-grid" style="margin-top:12px"></div>

            <div class="controls" style="margin-top:18px">
              <div style="flex:1"></div>
              <button id="btnProcess" class="btn primary" disabled type="button" title="Enviar para processamento">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" style="color:inherit">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                  <path d="M7 10l5-5 5 5" />
                  <path d="M12 5v12" />
                </svg>
                <span class="btn-label">Processar</span>
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Processing Screen -->
      <section id="processingScreen" style="display:none; border-top:1px solid var(--border)">
        <div class="processing">
          <div class="spinner" role="status" aria-hidden="true"></div>
          <h3 id="processingTitle">Processando arquivos</h3>
          <p id="processingSubtitle">Enviando para o serviço. Aguarde...</p>
        </div>
      </section>

      <!-- Results Screen -->
      <section id="resultsScreen" style="display:none; border-top:1px solid var(--border)">
        <div class="results">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <h2 id="resultsTitle" style="margin:0">Processamento concluído</h2>
              <div id="resultsSubtitle" style="color:var(--muted); margin-top:6px">Arquivos retornados pelo serviço</div>
            </div>
            <div>
              <button id="btnNew" class="btn primary" type="button">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" style="color:inherit">
                  <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                <span class="btn-label">Novo envio</span>
              </button>
            </div>
          </div>

          <div id="resultsGrid" class="results-grid"></div>
        </div>
      </section>
    </main>
  </div>

  <script>
    const MAX_FILES = 8;
    let selectedFiles = [];
    let processedFiles = [];
    let objectUrls = [];

    // Elements
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const filesList = document.getElementById('filesList');
    const filesGrid = document.getElementById('filesGrid');
    const counterBadge = document.getElementById('counterBadge');
    const btnProcess = document.getElementById('btnProcess');
    const btnAddMore = document.getElementById('btnAddMore');
    const btnClear = document.getElementById('btnClear');
    const uploadHint = document.getElementById('uploadHint');
    const btnChoose = document.getElementById('btnChoose');

    const processingScreen = document.getElementById('processingScreen');
    const processingTitle = document.getElementById('processingTitle');
    const processingSubtitle = document.getElementById('processingSubtitle');

    const resultsScreen = document.getElementById('resultsScreen');
    const resultsGrid = document.getElementById('resultsGrid');
    const resultsTitle = document.getElementById('resultsTitle');
    const resultsSubtitle = document.getElementById('resultsSubtitle');
    const btnNew = document.getElementById('btnNew');

    // Prevent double dialog when clicking label inside uploadArea
    btnChoose.addEventListener('click', (e) => {
      e.stopPropagation();
    });

    uploadArea.addEventListener('click', (e) => {
      if (e.target.closest && e.target.closest('#btnChoose')) return;
      fileInput.click();
    });

    // Drag & drop
    uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('hover'); });
    uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('hover'));
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('hover');
      const files = Array.from(e.dataTransfer.files || []);
      handleIncomingFiles(files);
    });

    // File selection
    fileInput.addEventListener('change', (e) => {
      handleIncomingFiles(Array.from(e.target.files || []));
      fileInput.value = '';
    });

    btnAddMore.addEventListener('click', () => fileInput.click());

    // Clear button
    let clearGuard = false;
    btnClear.addEventListener('click', () => {
      if (clearGuard) return;
      if (!selectedFiles.length) return;
      if (!confirm('Deseja remover todos os arquivos selecionados?')) return;
      clearGuard = true;
      setTimeout(() => clearGuard = false, 600);
      selectedFiles = [];
      renderFilesList();
    });

    btnProcess.addEventListener('click', () => {
      if (!selectedFiles.length) return;
      startProcessing();
    });

    btnNew.addEventListener('click', () => {
      cleanupProcessed();
      selectedFiles = [];
      processedFiles = [];
      showUpload();
      renderFilesList();
    });

    function handleIncomingFiles(files){
      const valid = files.filter(f => {
        const n = f.name.toLowerCase();
        return n.endsWith('.xlsx') || n.endsWith('.xls');
      });

      if (!valid.length){
        alert('Apenas arquivos .xlsx ou .xls são aceitos.');
        return;
      }

      const remaining = MAX_FILES - selectedFiles.length;
      const toAdd = valid.slice(0, remaining);
      selectedFiles = selectedFiles.concat(toAdd);

      if (valid.length > toAdd.length){
        alert(`Atenção: máximo ${MAX_FILES} arquivos. ${valid.length - toAdd.length} arquivo(s) não foram adicionados.`);
      }
      renderFilesList();
    }

    function renderFilesList(){
      counterBadge.textContent = `${selectedFiles.length} / ${MAX_FILES}`;
      uploadHint.textContent = selectedFiles.length ? `${selectedFiles.length} arquivo(s) selecionado(s)` : 'Nenhum envio ainda';

      if (!selectedFiles.length){
        filesList.style.display = 'none';
        btnProcess.disabled = true;
        btnAddMore.style.display = 'none';
        return;
      }

      filesList.style.display = 'block';
      btnProcess.disabled = false;
      btnAddMore.style.display = selectedFiles.length < MAX_FILES ? 'inline-flex' : 'none';

      filesGrid.innerHTML = '';
      selectedFiles.forEach((file, idx) => {
        const card = document.createElement('div');
        card.className = 'file-card';

        const thumb = document.createElement('div');
        thumb.className = 'file-thumb';
        thumb.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" style="color:var(--success)"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg>';

        const meta = document.createElement('div');
        meta.className = 'file-meta';
        const name = document.createElement('div');
        name.className = 'file-name';
        name.title = file.name;
        name.textContent = file.name;
        const size = document.createElement('div');
        size.className = 'file-size';
        size.textContent = formatBytes(file.size);

        meta.appendChild(name);
        meta.appendChild(size);

        const actions = document.createElement('div');
        actions.className = 'file-actions';
        const btnRemove = document.createElement('button');
        btnRemove.type = 'button';
        btnRemove.title = 'Remover arquivo';
        btnRemove.className = 'icon-btn danger';
        btnRemove.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" style="color:var(--danger)"><path d="M6 18L18 6M6 6l12 12"/></svg>';
        btnRemove.addEventListener('click', () => {
          selectedFiles.splice(idx, 1);
          renderFilesList();
        });
        actions.appendChild(btnRemove);

        card.appendChild(thumb);
        card.appendChild(meta);
        card.appendChild(actions);

        filesGrid.appendChild(card);
      });
    }

    function formatBytes(bytes){
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B','KB','MB','GB','TB'];
      const i = Math.floor(Math.log(bytes)/Math.log(k));
      return (bytes / Math.pow(k, i)).toFixed(i ? 2 : 0) + ' ' + sizes[i];
    }

    async function startProcessing(){
      showProcessing();
      processingTitle.textContent = 'Enviando arquivos para processamento';
      processingSubtitle.textContent = 'Aguarde — enviando os arquivos para o serviço.';

      const fd = new FormData();
      selectedFiles.forEach((f, i) => fd.append(`file${i+1}`, f));

      const webhookURL = 'https://projeto-teste-n8n.ly7t0m.easypanel.host/webhook/processar-8-arquivos';

      try {
        const resp = await fetch(webhookURL, { method: 'POST', body: fd });

        if (!resp.ok) {
          const text = await resp.text().catch(()=> '');
          throw new Error(text || `Resposta do servidor: ${resp.status}`);
        }

        const blob = await resp.blob();
        const contentType = resp.headers.get('content-type') || blob.type || 'application/octet-stream';
        
        // Extrai o nome do arquivo exatamente como vem do N8N (sem renomear)
        let fileName = null;
        const cd = resp.headers.get('content-disposition');
        
        if (cd){
          // tenta extrair filename do Content-Disposition (RFC 6266 / RFC 2183)
          // suporta: filename="name"; filename*=UTF-8''name; etc
          const match = cd.match(/filename\*?=(?:UTF-8'')?["']?([^;"'\n]+)/i);
          if (match && match[1]){
            fileName = decodeURIComponent(match[1].trim());
          }
        }

        // Se não conseguir extrair ou estiver vazio, usa o blob
        // Sem fallback — mostra exatamente o que N8N enviou
        if (!fileName){
          console.warn('Content-Disposition header não encontrado ou inválido. Usando nome vazio.');
          fileName = '';
        }

        const url = URL.createObjectURL(blob);
        objectUrls.push(url);
        processedFiles = [{ name: fileName, size: blob.size, type: contentType, url, blob }];

        processingTitle.textContent = 'Concluído';
        processingSubtitle.textContent = 'Arquivo recebido com sucesso.';
        setTimeout(() => showResults(), 450);

      } catch (err){
        console.error('Erro no envio/recebimento:', err);
        processingTitle.textContent = 'Erro';
        processingSubtitle.textContent = 'Ocorreu um erro no processamento.';
        alert('Erro ao processar: ' + (err.message || err));
        showUpload();
      }
    }

    // UI transitions
    function showProcessing(){
      document.getElementById('uploadScreen').style.display = 'none';
      filesList.style.display = 'none';
      processingScreen.style.display = 'block';
      resultsScreen.style.display = 'none';
    }
    function showResults(){
      document.getElementById('uploadScreen').style.display = 'none';
      processingScreen.style.display = 'none';
      resultsScreen.style.display = 'block';
      renderResults();
    }
    function showUpload(){
      document.getElementById('uploadScreen').style.display = 'block';
      processingScreen.style.display = 'none';
      resultsScreen.style.display = 'none';
    }

    function renderResults(){
      resultsGrid.innerHTML = '';
      if (!processedFiles.length){
        resultsTitle.textContent = 'Nenhum arquivo retornado';
        resultsSubtitle.textContent = 'Não foram encontrados arquivos após o processamento.';
        return;
      }

      resultsTitle.textContent = 'Processamento concluído';
      resultsSubtitle.textContent = `${processedFiles.length} arquivo(s) disponível(is) para download`;

      processedFiles.forEach((f) => {
        const item = document.createElement('div');
        item.className = 'result-item';

        const meta = document.createElement('div');
        meta.className = 'result-meta';

        const thumb = document.createElement('div');
        thumb.className = 'result-thumb';
        thumb.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" style="color:var(--primary)"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg>';

        const details = document.createElement('div');
        details.style.minWidth = '0';
        const name = document.createElement('div');
        name.className = 'result-name';
        name.title = f.name;
        name.textContent = f.name || '(sem nome)'; // mostra "(sem nome)" se o nome estiver vazio
        const size = document.createElement('div');
        size.className = 'result-size';
        size.textContent = formatBytes(f.size);

        details.appendChild(name);
        details.appendChild(size);

        meta.appendChild(thumb);
        meta.appendChild(details);

        const actions = document.createElement('div');
        actions.style.display = 'flex';
        actions.style.gap = '8px';

        // Botão Download (button, não link)
        const dlBtn = document.createElement('button');
        dlBtn.className = 'btn primary';
        dlBtn.type = 'button';
        dlBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" style="color:currentColor"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><path d="M7 10l5 5 5-5"/><path d="M12 15V3"/></svg><span class="btn-label">Download</span>';
        dlBtn.addEventListener('click', () => {
          const a = document.createElement('a');
          a.href = f.url;
          // Se o nome está vazio, deixa o browser decidir o nome padrão
          if (f.name) {
            a.download = f.name;
          }
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        });
        actions.appendChild(dlBtn);

        item.appendChild(meta);
        item.appendChild(actions);

        resultsGrid.appendChild(item);
      });
    }

    function cleanupProcessed(){
      objectUrls.forEach(u => URL.revokeObjectURL(u));
      objectUrls = [];
    }

    window.addEventListener('beforeunload', () => cleanupProcessed());

    // initial state
    renderFilesList();
  </script>
</body>
</html>
